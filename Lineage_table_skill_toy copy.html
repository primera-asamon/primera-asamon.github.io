<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <title>ãƒªãƒãƒ¼ã‚¸ãƒ¥ãƒªãƒã‚¹ã‚¿ãƒ¼ãƒ»ã‚¹ã‚­ãƒ«ä¸€è¦§</title>
    <meta name="description" content="">
    <meta name="keywords" content="">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/3.0.3/normalize.css">
    <!-- <link rel="stylesheet" href="normalize.css"> -->
    <!-- ã‚¢ã‚¤ã‚³ãƒ³ãƒ•ã‚©ãƒ³ãƒˆã®åˆ©ç”¨æ–¹æ³• http://fortawesome.github.io/Font-Awesome/ -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <!-- <link rel="stylesheet" href="font-awesome.min.css"> -->
    <link rel="stylesheet" href="Lineage_main.css">
    <link rel="stylesheet" href="Lineage_skill.css">
    <!-- <script src="jquery.min.js"></script> -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body id="top">
    <div class="nav">
        <ul class="nav-group">
            <li><a href="index.html">ãƒ›ãƒ¼ãƒ </a><i class="fa fa-home"></i></li>
            <li><a href="Lineage_table_monster.html">Monsters</a></li>
            <li><a href="Lineage_table_drop.html">Drops</a></li>
            <li><a href="Lineage_table_skill.html" class="active">&nbsp;Skills</a></li>
            <li><a href="LineageREMASTER_IME.html">IME</a></li>
            <li><a href="LineageREMASTER_ATOK.html">ATOK</a></li>
            <li><a href="LineageREMASTER_etc.html">è«¸è¡¨</a></li>
            <li><a href="font.html">å¤§å­—</a></li>
            <li><a href="inkey_JAJP.html">æŠ¼ä¸‹é‡¦</a></li>
        <li><a href="updates.html">å¤‰æ›´æ­´</a></li>        </ul>
    </div>
<!-- ãƒšãƒ¼ã‚¸å†’é ­ã«éè¡¨ç¤ºã§èª­ã¿ä¸Šã’å¯¾å¿œã®å›½éš›åŒ–ãƒ»èª¬æ˜ãƒ†ã‚­ã‚¹ãƒˆ -->
    <p id="screenreader-info" lang="en">
        This page lists MMORPG skills for Japanese-speaking players. It does not contain navigation or language switching. If you are using a screen reader or are not fluent in Japanese, please note that this page is for reference only and may not offer interactive support.
    </p>
<!-- æ—¥æœ¬èªã§ã®ãƒšãƒ¼ã‚¸èª¬æ˜ï¼ˆè¦–èªè¡¨ç¤ºå¯ï¼‰ -->
    <p id="screenreader-info_jp" class="page-description">
        ã“ã®ãƒšãƒ¼ã‚¸ã¯æ—¥æœ¬èªè©±è€…å‘ã‘ã«è¨­è¨ˆã•ã‚ŒãŸMMORPGã‚¹ã‚­ãƒ«ã®ä¸€è¦§è¡¨ã§ã™ã€‚ãƒªãƒ³ã‚¯ã‚„ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã¯è¨­ã‘ã¦ãŠã‚‰ãšã€ãƒšãƒ¼ã‚¸å…¨ä½“ã®å†…å®¹ã‚’1ãƒšãƒ¼ã‚¸ã§å®Œçµã™ã‚‹æ§‹æˆã«ãªã£ã¦ã„ã¾ã™ã€‚å†…å®¹ã®æŠŠæ¡ã‚’ä¸»ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚
    </p>
<!-- æŠ€è¡“ãƒ»é­”æ³•ä¸€è¦§ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ(æ—§ä»•æ§˜)â€»ã‚¹ãƒãƒ›ã§ã¯å–å¾—ã§ããªã„ã‹ã‚‰ 
 <input type="file" id="fileInput">
-->
<!-- æŠ€è¡“ãƒ»é­”æ³•ä¸€è¦§ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ(å‰ä»•æ§˜)â€»ãƒ•ã‚¡ã‚¤ãƒ«å…¨ä½“ã®ãƒšãƒ¼ã‚¹ãƒˆ(é•·å¤§ãªãƒ‡ãƒ¼ã‚¿ã§ã¯ä¸é©å½“) -->
<!-- <button id="submitBtn">è¡¨ç¤º</button>
     <div id="output"></div>
-->
<!-- æŠ€è¡“ãƒ»é­”æ³•ä¸€è¦§ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ(æ–°ä»•æ§˜)â€»ãƒ•ã‚¡ã‚¤ãƒ«åã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <button id="loadBtn">è¡¨ç¤º</button>
<!-- HTMLï¼ˆãƒœã‚¿ãƒ³ã‚„ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’è¿½åŠ ï¼‰ -->
    <div id="classFilterBtns" style="margin-bottom: 15px;">
        <button class="class-btn" data-cls="all">all</button>
        <button class="class-btn" data-cls="å›">å›</button>
        <button class="class-btn" data-cls="é¨">é¨</button>
        <button class="class-btn" data-cls="å¦–" data-elf="ç«">ç«</button>
        <button class="class-btn" data-cls="å¦–" data-elf="æ°´">æ°´</button>
        <button class="class-btn" data-cls="å¦–" data-elf="é¢¨">é¢¨</button>
        <button class="class-btn" data-cls="å¦–" data-elf="åœ°">åœ°</button>
        <button class="class-btn" data-cls="é­”">é­”</button><br>
        <button class="class-btn" data-cls="é—‡">é—‡</button>
        <button class="class-btn" data-cls="ç«œ">ç«œ</button>
        <button class="class-btn" data-cls="æˆ¦">æˆ¦</button>
        <button class="class-btn" data-cls="å‰£">å‰£</button>
        <button class="class-btn" data-cls="æ§">æ§</button>
        <button class="class-btn" data-cls="å¹»">å¹»</button>
        <button class="class-btn" data-cls="è–">è–</button>
        <button class="class-btn" data-cls="é—˜">é—˜</button> <!-- ãƒ•ã‚¡ã‚¤ã‚¿ãƒ¼fighter -->
 <!-- ã‚¹ã‚­ãƒ«ä¸€è¦§ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ -->
        <label><input type="radio" name="matchType" value="only" checked> å®Œå…¨ä¸€è‡´</label>
        <label><input type="radio" name="matchType" value="includes"> éƒ¨åˆ†ä¸€è‡´</label>
    </div>
<!-- æŠ€è¡“ãƒ»é­”æ³•ä¸€è¦§ã®è¡¨ç¤ºå ´æ‰€ â†“-->    
    <div id="result">
    </div>
<!-- æŠ€è¡“ãƒ»é­”æ³•ä¸€è¦§ã®è¡¨ç¤ºå ´æ‰€ â†‘-->    
<!-- è„šæ³¨ãƒ»æ¨©åˆ©è¡¨è¨˜ -->
    <div class="footer-text">
        <footer role="contentinfo">
            <section lang="ja">
                <h5 class="sr-only">è‘—ä½œæ¨©æƒ…å ±</h5>
                <small>å½“ã‚µã‚¤ãƒˆã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ãƒªãƒãƒ¼ã‚¸ãƒ¥ã®ç”»åƒãƒ»BGMåŠã³ãã®ä»–ã®è¡¨ç¾ç‰©ã®æ¨©åˆ©ã¯ä¸‹è¨˜ã®ã¨ãŠã‚Šæ¨©åˆ©è€…ã«å¸°å±ã—ã¾ã™ï¼š</small>
            </section>
            <section lang="en">
                <h5 class="sr-only">Copyright notice</h5>
                <small>Lineage and Lineage Eternal Life are registered trademarks of NCsoft Corporation.&copy;  1998-2011 Copyright NCsoft Corporation. NC Japan K.K. was granted by NCsoft Corporation the right to publish, distribute, and transmit Lineage Eternal Life in Japan. All Rights Reserved.</small>
            </section>
            <section lang="zh-TW">
                <h5 class="sr-only">ç‰ˆæƒå£°æ˜</h5>
                <small>æœ¬é é¢ä½¿ç”¨ä¹‹ã€ŠLineageã€‹ç›¸é—œç´ æï¼Œå…¶ç‰ˆæ¬Šçš†å±¬åŸå‰µä½œè€…æ‰€æœ‰ã€‚</small>
            </section>
        </footer>
    </div>
<!-- ãƒšãƒ¼ã‚¸ä¸Šéƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã™ã‚‹ãƒœã‚¿ãƒ³ -->
<p>
    <a href="#top" class="btn-pagetop" aria-label="ãƒšãƒ¼ã‚¸ã®å…ˆé ­ã¸æˆ»ã‚‹">
        <i class="fa fa-arrow-up fa-2x" aria-hidden="true"></i>
        <span class="label-text">ãƒšãƒ¼ã‚¸å…ˆé ­ã¸</span>
    </a>
</p>
<!-- FC2ã§ã¯application/scriptã§ã‚‚jsãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿æ™‚ã«text/htmlã«å¤‰æ›´ã•ã‚Œé§†å‹•ã—ãªã„ã€‚Javascriptä¸­ã«htmlã‚¿ã‚°ã§é–‹å§‹ã•ã‚Œã‚‹è¡ŒãŒã‚ã‚‹å ´åˆèª¤èªã•ã‚Œã‚‹ã€‚
å¯¾ç­–ï¼šå…¨ã¦ã®è¡Œã¯html_pcv =+`ï½ã§ã¯ã˜ã‚ã‚‹ã“ã¨ã€‚ã¾ãŸã¯jsç‹¬ç«‹ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ãã‚‰ã‚ã‚‹ã€‚ -->
<!--    <script src="lineage_skill.js" defer></script> -->
<script>
    let html_pcv = ''; // PCç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ ¼ç´ç”¨
    let html_spv = ''; // ã‚¹ãƒãƒ›ç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ ¼ç´ç”¨*æœªå®Ÿè£…
// ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®èª­ã¿è¾¼ã¿ã‚’å¾…ã¤ãŸã‚ã®DOMContentLoadedã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOMèª­ã¿è¾¼ã¿å®Œäº†");
    });
// document.getElementById('fileInput').addEventListener('change', function(e) {
//ã‚¹ãƒãƒ›ã§ã¯ç„¡ç†ã ã‹ã‚‰TSVé¸æŠã¯ã•ã›ãªã„ã€‚TSVãƒ•ã‚¡ã‚¤ãƒ«åã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã€‚
document.getElementById('loadBtn').addEventListener('click', function () {
    // è‹±æ–‡ãƒ»æ—¥æœ¬èªã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼å‘ã‘èª¬æ˜ã‚’éè¡¨ç¤ºã«
    const info_en = document.getElementById("screenreader-info");
    const info_jp = document.getElementById("screenreader-info_jp");

    if (!info_en.classList.contains("sr-only")) {
        info_en.classList.add("sr-only");
    }
    if (!info_jp.classList.contains("sr-only")) {
        info_jp.classList.add("sr-only");
    }

    // å‘ŠçŸ¥æ–‡ã‚’éè¡¨ç¤ºã«
    const notice = document.getElementById("notice");
    if (notice) {
        notice.style.display = "none";
    }

    // urlæƒé™¤ã€‚ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã‚’ã‚¤ãƒ™ãƒ³ãƒˆã¨ã—ã¦å‡¦ç†ã™ã‚‹ã®ã¯å®¿é¡Œã€‚ä»Šã¯è¡¨ç¤ºãƒœã‚¿ãƒ³ãŒãƒˆãƒªã‚¬ãƒ¼ã€‚
// è¡¨ç¤ºã•ã‚Œã¦ã„ãªã„çŠ¶æ…‹ãªã®ã« #class=xxx ãŒã‚ã‚‹ãªã‚‰ãƒãƒƒã‚·ãƒ¥ã‚’æ¶ˆã™
    if (!document.getElementById('result').innerHTML && location.hash.includes("class=")) {
        history.replaceState(null, null, location.pathname);
    }
// TSVèª­ã¿è¾¼ã¿ã¨æç”» ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é™„ä¸ã—ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚ˆã‚‹å¼·åˆ¶å†èª­ã¿è¾¼ã¿ã«ã‚ˆã£ã¦ã€FC2Serverã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¿å‘½ã‚’å›é¿ã€‚
    fetch('LineageREMASTER_skill3.tsv?v=' + new Date().getTime())
        .then(response => response.text())
        .then(text => {
//testç”¨
// èª­ã¿è¾¼ã¿æˆåŠŸæ™‚ã®å‡¦ç†
console.log("ã‚¹ã‚¯ãƒªãƒ—ãƒˆé–‹å§‹");
console.log("DOMèª­ã¿è¾¼ã¿å¾…æ©Ÿä¸­");

function setup() {
  console.log("setupé–‹å§‹");

  const btn = document.getElementById('loadBtn');
  if (btn) {
    console.log("ãƒœã‚¿ãƒ³å–å¾—æˆåŠŸ");
    btn.addEventListener('click', () => {
      console.log("ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯");
      fetch('LineageREMASTER_skill3.tsv?v=' + new Date().getTime())
        .then(response => {
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          return response.text();
        })
        .then(text => {
          console.log("èª­ã¿è¾¼ã¿æˆåŠŸ");
          document.getElementById('result').innerHTML = html_pcv;
//        document.getElementById('result').textContent = text;

//      DOMæ§‹ç¯‰å¾Œã«åˆæœŸåŒ–å‡¦ç†ã‚’ç¢ºå®Ÿã«å®Ÿè¡Œ
        requestAnimationFrame(() => {
            initializeTableBehavior();
        });

        })
        .catch(error => {
          console.error("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
        });
    });
  } else {
    console.log("loadBtn è¦‹ã¤ã‹ã‚‰ãš");
  }
}
// DOMContentLoaded ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦ã€DOMã®èª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã¤
if (document.readyState === 'loading') {
  console.log("DOMèª­ã¿è¾¼ã¿å¾…æ©Ÿä¸­");
  document.addEventListener('DOMContentLoaded', setup);
} else {
  console.log("DOMã™ã§ã«æ§‹ç¯‰æ¸ˆã¿ã€å³æ™‚å®Ÿè¡Œ");
  setup();
}
    // [è¡¨ç¤º]ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ï¼‹ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆ
    const loadBtn = document.getElementById("loadBtn");
    if (loadBtn) {
        loadBtn.disabled = true;
        loadBtn.style.opacity = "0.5";
        loadBtn.style.cursor = "not-allowed";
        loadBtn.title = "ã‚¯ãƒ©ã‚¹é¸æŠæ™‚ã«è‡ªå‹•è¡¨ç¤ºã•ã‚Œã‚‹ãŸã‚ã€ã“ã®ãƒœã‚¿ãƒ³ã¯ä¸è¦ã§ã™ã€‚";
    }
// ã“ã“ã«TSVãƒ‘ãƒ¼ã‚¹ï¼†è¡¨ç¤ºå‡¦ç†ã‚’æ›¸ã
        const lines = text.trim().split('\n');
        let html_pcv = `<table>`;
// filter_header
    // <!-- data-control fieldã”ã¨ã«å‡¦ç†åŒºåˆ†ã‚’è¨­å®šã™ã‚‹ 
    //sortï¼šã‚½ãƒ¼ãƒˆã‚¢ã‚¤ã‚³ãƒ³ãƒœã‚¿ãƒ³ã¨æ–‡å­—åˆ—ã¨ã—ã¦ã®ä¸¦ã³æ›¿ãˆ
    //numberï¼šã‚½ãƒ¼ãƒˆã‚¢ã‚¤ã‚³ãƒ³ãƒœã‚¿ãƒ³ã¨æ•°å€¤ã¨ã—ã¦ã®ä¸¦ã³æ›¿ãˆ
    //refineï¼šãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ãƒœã‚¿ãƒ³ã¨ã‚¯ãƒªãƒƒã‚¯ã«ã‚ˆã‚‹ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º
    //checklistï¼šãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ä»˜ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã‚’è¡¨ç¤ºã™ã‚‹
    //--> 
// No.ã¨Levelã¨ã‚¹ã‚­ãƒ«åã¯theaderã§ã¯ä½¿ç”¨ã—ãªã„ã€‚1+1+9=11åˆ—ã€‚
          html_pcv += `<tbody id="filter_header" class="record-table" data-cls="å›é¨å¦–é­”é—‡ç«œæˆ¦å‰£æ§å¹»è–" data-elf="å…±">`
          html_pcv += `<tr class="record-title">
            <th class="col-data_no">No.</th>
            <th class="col-data_level">Lv.</th>
            <th class="col-data_skillname" colspan="9">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</th>
          </tr>`
            // skill_domain_tendency:2+2+2=6åˆ—
          html_pcv += `<tr>
            <th class="col-header" colspan="5">ç¿’å¾—ã‚¯ãƒ©ã‚¹</th>
            <th class="col-header" data-control="sort refine checklist" colspan="2">æ´»æ€§</th>
            <th class="col-header" data-control="sort refine checklist" colspan="2">ç¨®é¡</th>
            <th class="col-header" data-control="sort refine checklist" colspan="2">æ€§å‘</th>
          </tr>`
            // skill_domain_resource:2+2+3+2+2=11åˆ—
          html_pcv += `<tr>
            <th class="col-header" data-control="sort number" colspan="2">æ¶ˆè€—MP</th>
            <th class="col-header" data-control="sort number" colspan="2">æ¶ˆè€—HP</th>
            <th class="col-header" colspan="3">ææ–™ãƒ»è§¦åª’</th>
            <th class="col-header" data-control="sort refine checklist" colspan="2">è£…å‚™æ¡ä»¶</th>
            <th class="col-header" colspan="2">æŒç¶šæ™‚é–“</th>
          </tr>`
            // skill_domain_effect:3+2+6=11åˆ—
          html_pcv += `<tr>
            <th class="col-header" colspan="3">å¯¾è±¡</th>
            <th class="col-header" colspan="2">å†ä½¿ç”¨æ™‚é–“</th>
            <th class="col-header" colspan="6">åŠ¹æœãƒ»æ€§èƒ½</th>
          </tr>`
            // skill_domain_acquisition:2+3+6=11åˆ—
          html_pcv += `<tr>
            <th class="col-header" colspan="2">ç¿’å¾—Lv.</th>
            <th class="col-header" data-control="sort refine checklist" colspan="3">å–å¾—æ–¹æ³•</th>
            <th class="col-header" colspan="6">ä¾¡æ ¼</th>
          </tr>`
            // skill_domain_dropmob:11åˆ—
          html_pcv += `<tr>
            <th class="col-header" colspan="11">ãƒ‰ãƒ­ãƒƒãƒ—</th>
          </tr>`
            // skill_domain_dropmob:11åˆ—
          html_pcv += `<tr>
            <th class="col-header" colspan="11">ã€è˜‡ç”Ÿã€‘</th>
          </tr>`
            // skill_domain_notes:6+5=11åˆ—
          html_pcv += `<tr>
            <th class="col-header" colspan="6">å‚™è€ƒ1</th>
            <th class="col-header" colspan="5">å‚™è€ƒ2</th>
          </tr>`
          html_pcv +=`</tbody>`
// tableå…¨ä½“ã®header
        for (const line of lines) {
            const fields = line.split('\t');
            console.log(`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ•°(${line}):`, fields.length); // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ•°ã‚’ç¢ºèª

            if (fields.length < 25) {
                console.warn("ãƒ‡ãƒ¼ã‚¿ä¸è¶³:", fields);
                continue; // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ•°ãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆã‚¹ã‚­ãƒƒãƒ—
            }
// å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å€¤ã‚’å¤‰æ•°ã«æ ¼ç´
            const [no,img,level,name,cls,elf,active,type,align,mp,hp,material,gear,duration,target,reuse,effect,acqLv,obtain,price,Droporigin,Dropcomp,note1,note2,EOR] = line.split('\t');
            // å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’TABåˆ†å‰² EOR(End Of Record)ã‚’ç„¡è¦–
            // imgã¯ç”»åƒã®URLã ãŒã€ã“ã“ã§ã¯ä½¿ç”¨ã—ãªã„ã®ã§ç„¡è¦–ã€‚å€¤ã¯"å…¨è§’Space"
            // EORã¯è¡Œã®çµ‚ã‚ã‚Šã‚’ç¤ºã™ãŒã€ã“ã“ã§ã¯ä½¿ç”¨ã—ãªã„ã®ã§ç„¡è¦–ã€‚å€¤ã¯"â– "

            // clsã¨elfã®ã¾ã¨ã‚è¡¨ç¤º
            let clsDisplay = cls;
            if (cls === "å¦–" && elf) {
                clsDisplay += `ï¼ˆ${elf}ï¼‰`;
            };
            html_pcv += `<tbody id="(${name})" class="record-table" data-cls=${cls} data-elf=${elf}>`;
            // No.ã¨Levelã¨ã‚¹ã‚­ãƒ«åã¯ã€Œ<th>ï½ã€ã‚’ä½¿ç”¨ã—ãªã„ã€‚1+1+9=11åˆ—ã€‚
                html_pcv += `<tr class="record-title">
                            <td class="col-data_no">No.${no}</td>`
                // ç­‰ç´šãƒ»ã‚¹ã‚­ãƒ«ãƒ¬ãƒ™ãƒ«ã®å‡ºåŠ›éƒ¨åˆ†
                            if (/^\d+$/.test(level)) {
                    // æ•°å­—ã®ã¿ã®å ´åˆ
                                html_pcv += `<td class="col-data_level">Lv.${level}</td>`;
                            } else {
                    // ç©ºã¾ãŸã¯æ–‡å­—åˆ—ï¼ˆç¥è©±ãƒ»ä¼èª¬ãªã©ï¼‰ã®å ´åˆ
                                html_pcv += `<td class="col-data_level">${level}</td>`;
                            }   
            html_pcv += `<td class="col-data_skillname" colspan="9">${name}</td>
                        </tr>`
            // skill_domain_eligible_character:5åˆ—
            // skill_domain_tendency:2+2+2=6åˆ—
                html_pcv += `<tr>
                            <th class="col-header">ç¿’å¾—ã‚¯ãƒ©ã‚¹</th><td class="col-data" colspan="4">${clsDisplay}</td>`
                html_pcv += `<th class="col-header">æ´»æ€§</th><td class="col-data">${active}</td>
                            <th class="col-header">ç¨®é¡</th><td class="col-data">${type}</td>
                            <th class="col-header">æ€§å‘</th><td class="col-data">${align}</td>
                        </tr>`
            // skill_domain_resource:2+2+3+2+2=11åˆ—
                html_pcv += `<tr>
                            <th class="col-header">æ¶ˆè€—MP</th><td class="col-data">${mp}</td>
                            <th class="col-header">æ¶ˆè€—HP</th><td class="col-data">${hp}</td>
                            <th class="col-header">ææ–™ãƒ»è§¦åª’</th><td class="col-data" colspan="2">${material}</td>
                            <th class="col-header">è£…å‚™æ¡ä»¶</th><td class="col-data">${gear}</td>
                            <th class="col-header">æŒç¶šæ™‚é–“</th><td class="col-data">${duration}</td>
                        </tr>`
            // skill_domain_effect:3+2+6=11åˆ—
                html_pcv += `<tr>
                            <th class="col-header">å¯¾è±¡</th><td class="col-data" colspan="2">${target}</td>
                            <th class="col-header">å†ä½¿ç”¨æ™‚é–“</th><td class="col-data">${reuse}</td>
                            <th class="col-header">åŠ¹æœãƒ»æ€§èƒ½</th><td class="col-data" colspan="5">${effect}</td>
                        </tr>`
            // skill_domain_acquisition:2+3+6=11åˆ—
                html_pcv += `<tr>
                            <th class="col-header">ç¿’å¾—Lv.</th><td class="col-data">${acqLv}</td>
                            <th class="col-header">å–å¾—æ–¹æ³•</th><td class="col-data" colspan="2">${obtain}</td>
                            <th class="col-header">ä¾¡æ ¼</th><td class="col-data" colspan="5">${price}</td>
                        </tr>`
            // skill_domain_dropmob:11åˆ—
                html_pcv += `<tr>
                            <th class="col-header">ãƒ‰ãƒ­ãƒƒãƒ—</th><td class="col-data" colspan="11">${Droporigin}</td>
                        </tr>`
            // skill_domain_dropmob:11åˆ—
                html_pcv += `<tr>
                            <th class="col-header">ã€è˜‡ç”Ÿã€‘</th><td class="col-data" colspan="11">${Dropcomp}</td>
                        </tr>`
            // skill_domain_notes:6+5=11åˆ—
                html_pcv += `<tr>
                            <th class="col-header">å‚™è€ƒ1</th><td class="col-data" colspan="5">${note1}</td>
                            <th class="col-header">å‚™è€ƒ2</th><td class="col-data" colspan="4">${note2}</td>
                        </tr>`
            html_pcv +=`</tbody>`
        }
        html_pcv += `</table>`;
                document.getElementById('result').innerHTML = html_pcv;
// ãƒ†ãƒ¼ãƒ–ãƒ«æç”»å¾Œ
// ã‚¯ãƒ©ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã®åˆæœŸåŒ–
        document.querySelectorAll('.class-btn').forEach(btn => {
            btn.classList.remove('active'); // ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
        });
// åˆæœŸçŠ¶æ…‹ã§ã€Œallã€ãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
document.querySelector('.class-btn[data-cls="all"]').classList.add('active');
// tbodyã”ã¨ã«åˆæœŸè¡¨ç¤ºã‚’è¨­å®šï¼ˆrecord-titleã®ã¿è¡¨ç¤ºï¼‰
document.querySelectorAll('tbody.record-table').forEach(tbody => {
    const isTarget = tbody.dataset.cls === 'all';
    tbody.dataset.collapsed = isTarget ? 'false' : 'true';
// å„ã‚¯ãƒ©ã‚¹æ¯ã®è¡¨ç¤ºéè¡¨ç¤ºåˆ¤å®šã¯ï¼Ÿ
    console.log(`tbody ${tbody.dataset.cls} â†’ collapsed=${tbody.dataset.collapsed}`);

    tbody.querySelectorAll('tr').forEach(tr => {
        const isTitle = tr.classList.contains('record-title');
        tr.style.display = (isTarget || isTitle) ? '' : 'none';
// isTitle=trueï¼Ÿãã‚Œã¨ã‚‚record-titleã§ãªã„è¡ŒãŒtrueãªã®ï¼Ÿ
        const text = tr.textContent.trim().slice(0, 10);
        console.log(`tr: "${text}", isTitle: ${isTitle}`);
    });
});
// å„ãƒœã‚¿ãƒ³ã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
document.querySelectorAll('.class-btn').forEach(btn => {
    btn.addEventListener('click', function () {
        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¯ãƒ©ã‚¹ã®åˆ‡ã‚Šæ›¿ãˆ
        document.querySelectorAll('.class-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        const selectedCls = this.dataset.cls;
        const selectedElf = this.dataset.elf || '';
        const matchType = document.querySelector('input[name="matchType"]:checked').value;
        // tbodyã”ã¨ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        document.querySelectorAll('tbody.record-table').forEach(tbody => {
            const cls = tbody.dataset.cls || '';
            const elf = tbody.dataset.elf || '';
        // åˆæœŸå€¤isMatchã¯falseï¼éè¡¨ç¤º
            let isMatch = false;
            if (selectedCls === 'all') {
                isMatch = true;
        // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®é¸æŠçŠ¶æ…‹
            } else if (matchType === 'only') {
        // å®Œå…¨ä¸€è‡´ãƒ¢ãƒ¼ãƒ‰
                if (selectedCls === 'å¦–') {
                    isMatch =
                        (cls === 'å¦–') &&
                        (elf === selectedElf || elf === 'å…±');
                } else {
                    isMatch = cls === selectedCls;
                }
            } else {
        // éƒ¨åˆ†ä¸€è‡´ãƒ¢ãƒ¼ãƒ‰
                if (selectedCls === 'å¦–') {
                    isMatch =
                        cls.includes('å¦–') &&
                        (elf === selectedElf || elf === 'å…±');
                } else {
                    isMatch = cls.includes(selectedCls);
                }
            }
            tbody.dataset.collapsed = 'true'; // æ—¢å®šï¼šæŠ˜ã‚ŠãŸãŸã¿
            tbody.querySelectorAll('tr').forEach(tr => {
                    // ä¸€è‡´ã™ã‚‹ã‚¯ãƒ©ã‚¹ã®ã¿è¡¨ç¤ºã€ãã†ã§ãªã‘ã‚Œã°å®Œå…¨éè¡¨ç¤º
                const isTitle = tr.classList.contains('record-title');
                tr.style.display = isMatch && isTitle ? '' : 'none';
            });
        });
    });
});
// ã‚¿ã‚¤ãƒˆãƒ«è¡Œã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼æŠ˜ã‚ŠãŸãŸã¿åˆ‡ã‚Šæ›¿ãˆ
document.querySelectorAll('.record-title').forEach(titleRow => {
    titleRow.addEventListener('click', function () {
        const tbody = this.closest('tbody');
        const isCollapsed = tbody.dataset.collapsed === 'true';

        tbody.dataset.collapsed = isCollapsed ? 'false' : 'true';

        tbody.querySelectorAll('tr').forEach(tr => {
            const isTitle = tr.classList.contains('record-title');
            tr.style.display = isCollapsed || isTitle ? '' : 'none';
        });
    });
});
// ã‚¯ãƒ©ã‚¹ã‚³ãƒ¼ãƒ‰ãƒãƒƒãƒ—(urlç”¨/æ•°å­—ã¯å…¬å¼webãƒšãƒ¼ã‚¸ã®ClassID)
const classCodeMap = {
//  "å…¨": "all"   //-/å…¨ã‚¯ãƒ©ã‚¹allã‚¯ãƒ©ã‚¹ã¨ã—ã¦è¨­å®šã—ãªã„ã€‚æœªå®šç¾©ã¨ã—ã¦å…¨ä»¶è¡¨ç¤ºæ‰±ã„ã€‚
  "å›": "pri",  //0/å›ä¸»princeãƒ»princess
  "é¨": "kni",  //1/ãƒŠã‚¤ãƒˆknight
  "å¦–": "elf",  //2/ã‚¨ãƒ«ãƒ•elf
  "é­”": "wiz",  //3/ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰wizard
  "é—‡": "dak",  //4/ãƒ€ãƒ¼ã‚¯ã‚¨ãƒ«ãƒ•darkelf
  "ç«œ": "dra",  //5/ãƒ‰ãƒ©ã‚´ãƒ³ãƒŠã‚¤ãƒˆdragonknight
  "å¹»": "ill",  //6/ã‚¤ãƒªãƒ¥ãƒ¼ã‚¸ãƒ§ãƒ‹ã‚¹ãƒˆillusionist
  "æˆ¦": "war",  //7/ã‚¦ã‚©ãƒªã‚¢ãƒ¼warrior
  "å‰£": "fen",  //8/ãƒ•ã‚§ãƒ³ã‚µãƒ¼Fencer
  "æ§": "lan",  //9/ãƒ©ãƒ³ã‚µãƒ¼lancer
  "è–": "Pal",  //10/ãƒ‘ãƒ©ãƒ‡ã‚£ãƒ³Paladin
  "é—˜": "fig"   //11/ãƒ•ã‚¡ã‚¤ã‚¿ãƒ¼fighter
};
// ã‚¯ãƒ©ã‚¹ã‚³ãƒ¼ãƒ‰å–å¾—é–¢æ•°
function getClassCode(label) {
  return classCodeMap[label] || "all"; // æœªå®šç¾©ãªã‚‰ä»®ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
}// ã‚¯ãƒ©ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°é–¢æ•°
document.querySelectorAll('.class-btn').forEach(btn => {
    btn.addEventListener('click', function () {
        const label = this.dataset.cls; // ãŸã¨ãˆã° "è–"
        const code = getClassCode(label); // ãŸã¨ãˆã° "hol"
        history.replaceState(null, null, `#class=${code}`);
//        filterByClass(code); // æ—¢å­˜ã®æ³¨å‡ºé–¢æ•°
    });
});
    // reader.readAsText(e.target.files[0], 'UTF-8');
    // console.log(text); // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ»341ä»¶24ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å†—é•·ã€‚
        })
        .catch(error => {
            document.getElementById('result').textContent = 'èª­ã¿è¾¼ã¿å¤±æ•—: ' + error;
        });
    // ã“ã“ã§addEventListenerã®é–¢æ•°ã‚’é–‰ã˜ã‚‹

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®å†ç™»éŒ²ã‚’å«ã‚ãŸåˆæœŸåŒ–é–¢æ•°â†“ã“ã“ã‹ã‚‰
function initializeTableBehavior() {
  console.log("ğŸ” initializeTableBehavior å®Ÿè¡Œ");
  document.querySelectorAll('tbody.record-table').forEach(tbody => {
    const isTarget = tbody.dataset.cls === 'all';
    tbody.dataset.collapsed = isTarget ? 'false' : 'true';
    console.log(`tbody ${tbody.dataset.cls} â†’ collapsed=${tbody.dataset.collapsed}`);
    tbody.querySelectorAll('tr').forEach(tr => {
      const isTitle = tr.classList.contains('record-title');
      tr.style.display = (isTarget || isTitle) ? '' : 'none';
    });
  });
  document.querySelectorAll('tr.record-title').forEach(titleRow => {
    titleRow.addEventListener('click', function () {
      const tbody = this.closest('tbody');
      const isCollapsed = tbody.dataset.collapsed === 'true';
      tbody.dataset.collapsed = isCollapsed ? 'false' : 'true';
      console.log(`ãƒˆã‚°ãƒ«: ${tbody.dataset.cls} â†’ ${tbody.dataset.collapsed}`);
      tbody.querySelectorAll('tr').forEach(tr => {
        const isTitle = tr.classList.contains('record-title');
        tr.style.display = isCollapsed || isTitle ? '' : 'none';
      });
    });
  });
}
// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®å†ç™»éŒ²ã‚’å«ã‚ãŸåˆæœŸåŒ–é–¢æ•°â†‘ã“ã“ã¾ã§
});

function scrollToFirstRecord() {
  var table = document.querySelector("table");
  var tbody = table.getElementsByTagName("tbody")[0];
  var firstRow = tbody.getElementsByTagName("tr")[0];
  firstRow.scrollIntoView({ behavior: 'smooth', block: 'start' });
  // ãƒ˜ãƒƒãƒ€ãƒ¼ã®é«˜ã•ã‚’å–å¾—
  var headerHeight = table.querySelector("thead.sticky").offsetHeight; //80pxã‚’å–å¾—Edgeã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚ˆã‚Šç¢ºèª
  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’èª¿æ•´ã—ã¦1ä»¶ç›®ã®è¡ŒãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹
  var firstRowTop = firstRow.getBoundingClientRect().top - document.body.getBoundingClientRect().top;
  window.scrollTo({ top: firstRowTop - headerHeight, behavior: 'smooth' });
}

/* â”€â”€ é–¢æ•°ï¼šåˆæœŸåŒ– â”€â”€ */
tblcontrol.init =()=> {
  //â”€] ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¿½åŠ 
  document.querySelectorAll( "tbody th[data-control]" ).forEach( th => {
  //â”€]â”€] å–å¾—
  const index = th.cellIndex;
  const table = th.closest( "table" );
  const tbody = table.querySelector( "tbody" );

  //â”€]â”€] ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
  const control = th.appendChild( document.createElement( "div" ) );
  control.classList.add( "tbl-control" );

  //â”€]â”€]â”€] ã‚½ãƒ¼ãƒˆ
  if( /sort/.test( th.dataset.control ) ){
  //â”€]â”€]â”€]â”€] æ˜‡é †ãƒœã‚¿ãƒ³
  const ascend = control.appendChild( document.createElement( "button" ) );
  ascend.dataset.type = "sort-ascend";
  ascend.appendChild( tblcontrol.btnicon.ascend.cloneNode( true ) );
  //â”€]â”€]â”€]â”€] é™é †ãƒœã‚¿ãƒ³
  const descend = control.appendChild( document.createElement( "button" ) );
  descend.dataset.type = "sort-descend";
  descend.appendChild( tblcontrol.btnicon.descend.cloneNode( true ) );
  //â”€]â”€]â”€]â”€] ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
  ascend.onclick = descend.onclick = tblcontrol.sort;
  }

  //â”€]â”€]â”€] çµè¾¼ã¿
  if( /refine/.test( th.dataset.control ) ){
  //â”€]â”€]â”€]â”€] ãƒœã‚¿ãƒ³
  const refine = control.appendChild( document.createElement( "button" ) );
  refine.dataset.type = "refine";
  refine.appendChild( tblcontrol.btnicon.refine.cloneNode( true ) );
  refine.onclick = tblcontrol.toggleFilter;

  //â”€]â”€]â”€]â”€] ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
  const filter = control.appendChild( document.createElement( "form" ) );
  filter.classList.add( "tbl-filter" );
  filter.onsubmit = tblcontrol.refine;
  filter.onreset = tblcontrol.unrefine;

  //â”€]â”€]â”€]â”€]â”€] å…¨é¸æŠ
  let div = filter.appendChild( document.createElement( "div" ) );
  div.classList.add( "tbl-filter-all" );
  let label = div.appendChild( document.createElement( "label" ) );
  let input = label.appendChild( document.createElement( "input" ) );
  input.name = "filter_all";
  input.type = "checkbox";
  input.checked = true;
  input.onchange = tblcontrol.checkAll;
  label.appendChild( document.createTextNode( "ã™ã¹ã¦" ) );

  // index: ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¯¾è±¡åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
  // th: indexç•ªç›®ã®thè¦ç´ 
  const th = table.querySelectorAll('th')[index];
  const controlValue = th.dataset.control || "";

  // checklistãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹åˆ¤å®š
  const isChecklist = controlValue.split(/\s+/).includes("checklist");

  //â”€]â”€]â”€]â”€]â”€] ã‚­ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ 
  div = filter.appendChild( document.createElement( "div" ) );
  div.classList.add( "tbl-filter-inventory" );
  if (isChecklist) {
    div.style.display = "block";
  }else{
    div.style.display = "none";
  }
  const list = [].reduce.call( tbody.rows, ( arr, row ) => {
    const text = row.cells[ index ].textContent;
    if( ! arr.includes( text ) ){ arr.push( text ) }
    return arr;
  }, [] );
  list.forEach( text => {
    label = div.appendChild( document.createElement( "label" ) );
    input = label.appendChild( document.createElement( "input" ) );
    input.name = "filter_item";
    input.type = "checkbox";
    input.value = text;
    input.checked = true;
    input.onchange = tblcontrol.checkAll;
    label.appendChild( document.createTextNode( text ) );
  } );
  filter.dataset.keyitem = JSON.stringify( list );

  //â”€]â”€]â”€]â”€]â”€] ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
  div = filter.appendChild( document.createElement( "div" ) );
  div.classList.add( "tbl-filter-keyword" );
  input = div.appendChild( document.createElement( "input" ) );
  input.name = "filter_keyword";
  input.type = "text";
  input.placeholder = "çµè¾¼ã¿ãƒ¯ãƒ¼ãƒ‰";
  input.style.width = "160px";
  filter.dataset.keyword = "";

  /* â†“ã€€textbox â†’ min/max 2025-08-17*/

  //â”€]â”€]â”€]â”€]â”€] min/maxï¼ˆæ•°å€¤åˆ—ã®ã¿ï¼‰
  if (/number/.test(th.dataset.control)) {
    div = filter.appendChild(document.createElement("div"));
    div.classList.add("tbl-filter-range");

    input = div.appendChild(document.createElement("input"));
    input.name = "min";
    input.type = "number";
    input.placeholder = "æœ€å°";
    input.style.width = "72px";
    input.className = "tbl-filter-minmax";

    input = div.appendChild(document.createElement("input"));
    input.name = "max";
    input.type = "number";
    input.placeholder = "æœ€å¤§";
    input.style.width = "72px";
    input.className = "tbl-filter-minmax";
  }

  /* â†‘ã€€textbox â†’ min/max */

  //â”€]â”€]â”€]â”€]â”€] å„ãƒœã‚¿ãƒ³
  div = filter.appendChild( document.createElement( "div" ) );
  div.classList.add( "tbl-filter-buttons" );

  input = div.appendChild( document.createElement( "input" ) );
  input.type = "submit";
  input.value = "çµè¾¼ã¿";

  input = div.appendChild( document.createElement( "input" ) );
  input.type = "reset";
  input.value = "ã‚¯ãƒªã‚¢";

  input = div.appendChild( document.createElement( "input" ) );
  input.type = "button";
  input.value = "ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‰ã˜ã‚‹";
  input.onclick = tblcontrol.toggleFilter;
  }
  } );
// â†“debugCode
//  document.querySelectorAll("thead th[data-control]").forEach(th => {
//    console.log("å¯¾è±¡åˆ—:", th.textContent.trim(), "å±æ€§:", th.dataset.control);
//  });
// â†‘debugCode
};

/* â”€â”€ é–¢æ•°ï¼šä¸¦ã³æ›¿ãˆ â”€â”€ */
tblcontrol.sort = evt => {
//â”€] HTML è¦ç´ 
const target = evt.target;
const thead = target.closest( "thead" );
const th = target.closest( "th" );
const tbody = target.closest( "table" ).querySelector( "tbody" );
//â”€] åˆ—ç•ªå·
const index = th.cellIndex;
//â”€] ã‚½ãƒ¼ãƒˆæ–¹æ³•
const type = target.dataset.type;
const numsort = /number/.test( th.dataset.control );
//â”€] ã‚½ãƒ¼ãƒˆ
Array.from( tbody.rows ).sort( ( row1, row2 ) => {
const [ a, b ] = [
row1.cells[ index ].textContent,
row2.cells[ index ].textContent
].map( value => numsort ? Number( value ) : value );
return a==b ? 0 :
type=="sort-ascend" ? ( a>b ? 1 : -1 ) : ( a>b ? -1 : 1 ) ;
} ).forEach( row => tbody.appendChild( row ) );
//â”€] ãƒœã‚¿ãƒ³ã®è‰²
thead.querySelectorAll( "button[ data-type|='sort' ]" ).
forEach( button => button.classList[ button==target ? "add" : "remove" ]( "filter" ) );
};

/* â”€â”€ é–¢æ•°ï¼šãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é–‹é–‰ â”€â”€ */
tblcontrol.toggleFilter = evt => {
//â”€] HTML è¦ç´ 
const target = evt.target.closest( ".tbl-control" ).querySelector( ".tbl-filter" );
const filters = target.closest( "thead" ).querySelectorAll( ".tbl-filter" );
//â”€] é–‹é–‰ãƒ•ãƒ©ã‚°
const open = ! target.classList.contains( "open" );
//â”€] ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é–‰ã˜ã‚‹
filters.forEach( filter => {
//â”€â”€] ãƒªã‚»ãƒƒãƒˆï¼šã‚­ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ 
const keyitem = JSON.parse( filter.dataset.keyitem );
filter.filter_item.forEach(
item => item.checked = keyitem.includes( item.value )
);
filter.filter_all.checked = Array.from( filter.filter_item ).every( item => item.checked ) ;
//â”€â”€] ãƒªã‚»ãƒƒãƒˆï¼šã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
const keyword =
filter.filter_keyword.value = filter.dataset.keyword;
//â”€â”€] ãƒœã‚¿ãƒ³ã®è‰²
filter.closest( "th" ).
querySelector( "button[ data-type='refine' ]" ).
classList[ ( ! keyword ) && filter.filter_all.checked ? "remove" : "add" ]( "filter" );
//â”€â”€] é–‰ã˜ã‚‹
filter.classList.remove( "open" );
} );
//â”€] ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é–‹ã
if( open ) target.classList.add( "open" );
};

/* â”€â”€ é–¢æ•°ï¼šå…¨é¸æŠ â”€â”€ */
tblcontrol.checkAll = evt => {
const target = evt.target;
const filter = target.form;
target.name=="filter_all" ?
Array.from( filter.filter_item ).forEach( item => item.checked = target.checked ) :
filter.filter_all.checked = Array.from( filter.filter_item ).every( item => item.checked ) ;
};

/* â”€â”€ é–¢æ•°ï¼šçµè¾¼ã¿ â”€â”€ */
/* â†“ã€€textbox â†’ min/max */

//-] é–¢æ•°æ•°å€¤ç¯„å›²ã§ã®çµã‚Šè¾¼ã¿

tblcontrol.refine = function(event) {
  event.preventDefault();

  const form = event.target;
  const th = form.closest("th");
  const colIndex = th.cellIndex;
  const rows = th.closest("table").tBodies[0].rows;

  // çµã‚Šè¾¼ã¿æ¡ä»¶å–å¾—ï¼ˆæ„å‘³ä¿è¨¼ã•ã‚ŒãŸå±æ€§ã‹ã‚‰ï¼‰
  const controlValue = th.dataset.control ?? "";
  const isNumber = controlValue.split(/\s+/).includes("number");
//  console.log(controlValue, isNumber, th.dataset.control); // â† ãƒ‡ãƒãƒƒã‚°ç”¨

  const min = isNumber ? parseFloat(form.min?.value) : undefined;
  const max = isNumber ? parseFloat(form.max?.value) : undefined;
  const keyword = form.filter_keyword?.value?.trim();

  // keyitemï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼‰å–å¾—
  const keyitem = form.filter_item
    ? Array.from(form.filter_item).filter(input => input.checked).map(input => input.value)
    : [];
  form.dataset.keyitem = JSON.stringify(keyitem);

  // è¡Œã”ã¨ã«çµã‚Šè¾¼ã¿åˆ¤å®š
  for (const row of rows) {
    const cell = row.cells[colIndex];
    const text = cell.textContent.trim();
    let show = true;

  // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«ã‚ˆã‚‹çµã‚Šè¾¼ã¿
    if (keyitem.length > 0 && !keyitem.includes(text)) {
    show = false;
  }

    if (isNumber) {
      const value = parseFloat(text);
      if (!isNaN(min) && value < min) show = false;
      if (!isNaN(max) && value >= max) show = false;

      // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ã®æ•°å€¤çµã‚Šè¾¼ã¿å®Œå…¨ä¸€è‡´
      if (keyword && text !== keyword) show = false;
    } else {
      // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ã®æ–‡å­—åˆ—çµã‚Šè¾¼ã¿éƒ¨åˆ†ä¸€è‡´
      if (keyword && !text.includes(keyword)) show = false;
    }

    row.style.display = show ? "" : "none";
  }
};

/* â”€â”€ ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆ â”€â”€ */
//â”€] ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
tblcontrol.stylesheet =
document.querySelector( "head" ).
appendChild( document.createElement( "style" ) ).sheet;
//â”€] é–¢æ•°
tblcontrol.css =( selector, style )=> {
const sheet = tblcontrol.stylesheet;
sheet.insertRule( `${ selector } { ${ style } }`, sheet.cssRules.length );
};
//â”€] è¨­å®š
//â”€]â”€] ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
tblcontrol.css( "th[ data-control ] .tbl-control", `
position: relative;
text-align: center;
` );
tblcontrol.css( "th[ data-control ] .tbl-control > button", `
width: 16px;
height: 16px;
padding: 0px;
margin: 2px;
border: solid 1px #ccc;
background: #eee;
cursor: pointer;
outline: none !important;
` );
tblcontrol.css( "th[ data-control ] .tbl-control > button:hover", `
border-color: #666;
` );
tblcontrol.css( "th[ data-control ] .tbl-control > button:active", `
background: #fff;
` );
tblcontrol.css( "th[ data-control ] .tbl-control button.filter", `
border-color: #fc6;
background: #ffc;
` );
tblcontrol.css( "th[ data-control ] .tbl-control button img", `
width: 100%; height: 100%;
border: none;
pointer-events: none;
` );
//â”€]â”€] ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
tblcontrol.css( "th[ data-control ] .tbl-filter", `
position: absolute; left: 0px; top: 100%; z-index: 100;
display: none;
box-sizing: border-box;
width: 200px;
padding: 4px;
margin: 0px;
border: solid 1px #ccc;
background: #ffe;
` );
tblcontrol.css( "th[ data-control ] .tbl-filter.open", `
display: block;
` );
tblcontrol.css( "th[ data-control ] .tbl-filter label", `
display: block;
text-align: left;
` );
tblcontrol.css( "th[ data-control ] .tbl-filter-inventory", `
max-height: 200px;
overflow: auto;
` );
tblcontrol.css( "th[ data-control ] .tbl-filter-keyword", `
margin: 4px auto;
` );
tblcontrol.css( "th[ data-control ] .tbl-filter-buttons input", `
box-sizing: border-box;
width: 164px;
margin: 2px;
` );
tblcontrol.css( `
th[ data-control ] .tbl-filter-buttons input[ value="çµè¾¼ã¿" ],
th[ data-control ] .tbl-filter-buttons input[ value="ã‚¯ãƒªã‚¢" ],
th[ data-control ] .tbl-filter-range input[ name="min" ],
th[ data-control ] .tbl-filter-range input[ name="max" ]
`, `
width: 80px;
margin: 2px;
` );

/* â”€â”€ ãƒœã‚¿ãƒ³ã‚¢ã‚¤ã‚³ãƒ³ â”€â”€ */
tblcontrol.btnicon = new Object();
//â”€] ã‚½ãƒ¼ãƒˆï¼šæ˜‡é †
tblcontrol.btnicon.ascend = new Image();
tblcontrol.btnicon.ascend.src = `data:image/svg+xml;charset=utf-8,
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
<polygon fill="%23666" stroke="none" points="8,3 3,11 13,11" />
</svg>`;
//â”€] ã‚½ãƒ¼ãƒˆï¼šé™é †
tblcontrol.btnicon.descend = new Image();
tblcontrol.btnicon.descend.src = `data:image/svg+xml;charset=utf-8,
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
<polygon fill="%23666" stroke="none" points="8,13 3,5 13,5" />
</svg>`;
//â”€] çµè¾¼ã¿
tblcontrol.btnicon.refine = new Image();
tblcontrol.btnicon.refine.src = `data:image/svg+xml;charset=utf-8,
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
<polygon fill="%23666" stroke="none" points="8,11 3,3 13,3" />
<rect fill="%23666" stroke="none" x="6" y="6" width="4" height="6" />
</svg>`;

/* â”€â”€ é–¢æ•°ï¼šåˆæœŸåŒ– â”€â”€ */
tblcontrol.init =()=> {
  //â”€] ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¿½åŠ 
  document.querySelectorAll( "th[ data-control ]" ).forEach( th => {
  //â”€]â”€] å–å¾—
  const index = th.cellIndex;
  const table = th.closest( "table" );
  const tbody = table.querySelector( "tbody" );

  //â”€]â”€] ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
  const control = th.appendChild( document.createElement( "div" ) );
  control.classList.add( "tbl-control" );

  //â”€]â”€]â”€] ã‚½ãƒ¼ãƒˆ
  if( /sort/.test( th.dataset.control ) ){
  //â”€]â”€]â”€]â”€] æ˜‡é †ãƒœã‚¿ãƒ³
  const ascend = control.appendChild( document.createElement( "button" ) );
  ascend.dataset.type = "sort-ascend";
  ascend.appendChild( tblcontrol.btnicon.ascend.cloneNode( true ) );
  //â”€]â”€]â”€]â”€] é™é †ãƒœã‚¿ãƒ³
  const descend = control.appendChild( document.createElement( "button" ) );
  descend.dataset.type = "sort-descend";
  descend.appendChild( tblcontrol.btnicon.descend.cloneNode( true ) );
  //â”€]â”€]â”€]â”€] ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
  ascend.onclick = descend.onclick = tblcontrol.sort;
  }

  //â”€]â”€]â”€] çµè¾¼ã¿
  if( /refine/.test( th.dataset.control ) ){
  //â”€]â”€]â”€]â”€] ãƒœã‚¿ãƒ³
  const refine = control.appendChild( document.createElement( "button" ) );
  refine.dataset.type = "refine";
  refine.appendChild( tblcontrol.btnicon.refine.cloneNode( true ) );
  refine.onclick = tblcontrol.toggleFilter;

  //â”€]â”€]â”€]â”€] ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
  const filter = control.appendChild( document.createElement( "form" ) );
  filter.classList.add( "tbl-filter" );
  filter.onsubmit = tblcontrol.refine;
  filter.onreset = tblcontrol.unrefine;

  //â”€]â”€]â”€]â”€]â”€] å…¨é¸æŠ
  let div = filter.appendChild( document.createElement( "div" ) );
  div.classList.add( "tbl-filter-all" );
  let label = div.appendChild( document.createElement( "label" ) );
  let input = label.appendChild( document.createElement( "input" ) );
  input.name = "filter_all";
  input.type = "checkbox";
  input.checked = true;
  input.onchange = tblcontrol.checkAll;
  label.appendChild( document.createTextNode( "ã™ã¹ã¦" ) );

  // index: ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¯¾è±¡åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
  // th: indexç•ªç›®ã®thè¦ç´ 
  const th = table.querySelectorAll('th')[index];
  const controlValue = th.dataset.control || "";

  // checklistãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹åˆ¤å®š
  const isChecklist = controlValue.split(/\s+/).includes("checklist");

  //â”€]â”€]â”€]â”€]â”€] ã‚­ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ 
  div = filter.appendChild( document.createElement( "div" ) );
  div.classList.add( "tbl-filter-inventory" );
  if (isChecklist) {
    div.style.display = "block";
  }else{
    div.style.display = "none";
  }
  const list = [].reduce.call( tbody.rows, ( arr, row ) => {
    const text = row.cells[ index ].textContent;
    if( ! arr.includes( text ) ){ arr.push( text ) }
    return arr;
  }, [] );
  list.forEach( text => {
    label = div.appendChild( document.createElement( "label" ) );
    input = label.appendChild( document.createElement( "input" ) );
    input.name = "filter_item";
    input.type = "checkbox";
    input.value = text;
    input.checked = true;
    input.onchange = tblcontrol.checkAll;
    label.appendChild( document.createTextNode( text ) );
  } );
  filter.dataset.keyitem = JSON.stringify( list );

  //â”€]â”€]â”€]â”€]â”€] ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
  div = filter.appendChild( document.createElement( "div" ) );
  div.classList.add( "tbl-filter-keyword" );
  input = div.appendChild( document.createElement( "input" ) );
  input.name = "filter_keyword";
  input.type = "text";
  input.placeholder = "çµè¾¼ã¿ãƒ¯ãƒ¼ãƒ‰";
  input.style.width = "160px";
  filter.dataset.keyword = "";

  /* â†“ã€€textbox â†’ min/max 2025-08-17*/

  //â”€]â”€]â”€]â”€]â”€] min/maxï¼ˆæ•°å€¤åˆ—ã®ã¿ï¼‰
  if (/number/.test(th.dataset.control)) {
    div = filter.appendChild(document.createElement("div"));
    div.classList.add("tbl-filter-range");

    input = div.appendChild(document.createElement("input"));
    input.name = "min";
    input.type = "number";
    input.placeholder = "æœ€å°";
    input.style.width = "72px";
    input.className = "tbl-filter-minmax";

    input = div.appendChild(document.createElement("input"));
    input.name = "max";
    input.type = "number";
    input.placeholder = "æœ€å¤§";
    input.style.width = "72px";
    input.className = "tbl-filter-minmax";
  }

  /* â†‘ã€€textbox â†’ min/max */

  //â”€]â”€]â”€]â”€]â”€] å„ãƒœã‚¿ãƒ³
  div = filter.appendChild( document.createElement( "div" ) );
  div.classList.add( "tbl-filter-buttons" );

  input = div.appendChild( document.createElement( "input" ) );
  input.type = "submit";
  input.value = "çµè¾¼ã¿";

  input = div.appendChild( document.createElement( "input" ) );
  input.type = "reset";
  input.value = "ã‚¯ãƒªã‚¢";

  input = div.appendChild( document.createElement( "input" ) );
  input.type = "button";
  input.value = "ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‰ã˜ã‚‹";
  input.onclick = tblcontrol.toggleFilter;
  }
  } );
// â†“debugCode
//  document.querySelectorAll("thead th[data-control]").forEach(th => {
//    console.log("å¯¾è±¡åˆ—:", th.textContent.trim(), "å±æ€§:", th.dataset.control);
//  });
// â†‘debugCode
};

/* â”€â”€ é–¢æ•°ï¼šä¸¦ã³æ›¿ãˆ â”€â”€ */
tblcontrol.sort = evt => {
//â”€] HTML è¦ç´ 
const target = evt.target;
const thead = target.closest( "thead" );
const th = target.closest( "th" );
const tbody = target.closest( "table" ).querySelector( "tbody" );
//â”€] åˆ—ç•ªå·
const index = th.cellIndex;
//â”€] ã‚½ãƒ¼ãƒˆæ–¹æ³•
const type = target.dataset.type;
const numsort = /number/.test( th.dataset.control );
//â”€] ã‚½ãƒ¼ãƒˆ
Array.from( tbody.rows ).sort( ( row1, row2 ) => {
const [ a, b ] = [
row1.cells[ index ].textContent,
row2.cells[ index ].textContent
].map( value => numsort ? Number( value ) : value );
return a==b ? 0 :
type=="sort-ascend" ? ( a>b ? 1 : -1 ) : ( a>b ? -1 : 1 ) ;
} ).forEach( row => tbody.appendChild( row ) );
//â”€] ãƒœã‚¿ãƒ³ã®è‰²
thead.querySelectorAll( "button[ data-type|='sort' ]" ).
forEach( button => button.classList[ button==target ? "add" : "remove" ]( "filter" ) );
};

/* â”€â”€ é–¢æ•°ï¼šãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é–‹é–‰ â”€â”€ */
tblcontrol.toggleFilter = evt => {
//â”€] HTML è¦ç´ 
const target = evt.target.closest( ".tbl-control" ).querySelector( ".tbl-filter" );
const filters = target.closest( "thead" ).querySelectorAll( ".tbl-filter" );
//â”€] é–‹é–‰ãƒ•ãƒ©ã‚°
const open = ! target.classList.contains( "open" );
//â”€] ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é–‰ã˜ã‚‹
filters.forEach( filter => {
//â”€â”€] ãƒªã‚»ãƒƒãƒˆï¼šã‚­ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ 
const keyitem = JSON.parse( filter.dataset.keyitem );
filter.filter_item.forEach(
item => item.checked = keyitem.includes( item.value )
);
filter.filter_all.checked = Array.from( filter.filter_item ).every( item => item.checked ) ;
//â”€â”€] ãƒªã‚»ãƒƒãƒˆï¼šã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
const keyword =
filter.filter_keyword.value = filter.dataset.keyword;
//â”€â”€] ãƒœã‚¿ãƒ³ã®è‰²
filter.closest( "th" ).
querySelector( "button[ data-type='refine' ]" ).
classList[ ( ! keyword ) && filter.filter_all.checked ? "remove" : "add" ]( "filter" );
//â”€â”€] é–‰ã˜ã‚‹
filter.classList.remove( "open" );
} );
//â”€] ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é–‹ã
if( open ) target.classList.add( "open" );
};

/* â”€â”€ é–¢æ•°ï¼šå…¨é¸æŠ â”€â”€ */
tblcontrol.checkAll = evt => {
const target = evt.target;
const filter = target.form;
target.name=="filter_all" ?
Array.from( filter.filter_item ).forEach( item => item.checked = target.checked ) :
filter.filter_all.checked = Array.from( filter.filter_item ).every( item => item.checked ) ;
};

/* â”€â”€ é–¢æ•°ï¼šçµè¾¼ã¿ â”€â”€ */
/* â†“ã€€textbox â†’ min/max */

//-] é–¢æ•°æ•°å€¤ç¯„å›²ã§ã®çµã‚Šè¾¼ã¿

tblcontrol.refine = function(event) {
  event.preventDefault();

  const form = event.target;
  const th = form.closest("th");
  const colIndex = th.cellIndex;
  const rows = th.closest("table").tBodies[0].rows;

  // çµã‚Šè¾¼ã¿æ¡ä»¶å–å¾—ï¼ˆæ„å‘³ä¿è¨¼ã•ã‚ŒãŸå±æ€§ã‹ã‚‰ï¼‰
  const controlValue = th.dataset.control ?? "";
  const isNumber = controlValue.split(/\s+/).includes("number");
//  console.log(controlValue, isNumber, th.dataset.control); // â† ãƒ‡ãƒãƒƒã‚°ç”¨

  const min = isNumber ? parseFloat(form.min?.value) : undefined;
  const max = isNumber ? parseFloat(form.max?.value) : undefined;
  const keyword = form.filter_keyword?.value?.trim();

  // keyitemï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼‰å–å¾—
  const keyitem = form.filter_item
    ? Array.from(form.filter_item).filter(input => input.checked).map(input => input.value)
    : [];
  form.dataset.keyitem = JSON.stringify(keyitem);

  // è¡Œã”ã¨ã«çµã‚Šè¾¼ã¿åˆ¤å®š
  for (const row of rows) {
    const cell = row.cells[colIndex];
    const text = cell.textContent.trim();
    let show = true;

  // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«ã‚ˆã‚‹çµã‚Šè¾¼ã¿
    if (keyitem.length > 0 && !keyitem.includes(text)) {
    show = false;
  }

    if (isNumber) {
      const value = parseFloat(text);
      if (!isNaN(min) && value < min) show = false;
      if (!isNaN(max) && value >= max) show = false;

      // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ã®æ•°å€¤çµã‚Šè¾¼ã¿å®Œå…¨ä¸€è‡´
      if (keyword && text !== keyword) show = false;
    } else {
      // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ã®æ–‡å­—åˆ—çµã‚Šè¾¼ã¿éƒ¨åˆ†ä¸€è‡´
      if (keyword && !text.includes(keyword)) show = false;
    }

    row.style.display = show ? "" : "none";
  }
};

/* â”€â”€ é–¢æ•°ï¼šçµè¾¼ã¿è§£é™¤ â”€â”€ */
tblcontrol.unrefine = evt => {
const filter = evt.target;
filter.filter_all.checked = true;
Array.from( filter.filter_item ).forEach( item => item.checked = true );
filter.filter_keyword.value = "";

/* â†“ã€€textbox â†’ min/max 2025-08-17*/
filter.min.value = "";
filter.max.value = "";
/* â†‘ã€€textbox â†’ min/max */

tblcontrol.refine( evt );
};

/* â”€â”€ tsvèª­ã¿è¾¼ã¿ä»¥å‰ï¼šå…¨ãƒ¬ã‚³ãƒ¼ãƒ‰htmlè¨˜è¿°æ™‚ä»£ã®æ—§ãƒ»å®Ÿè£… â”€â”€ */
// tblcontrol.init()ã¯æœ€åˆã®requestAnimationFrame()ã®ä¸­ã§å‘¼ã³å‡ºã•ã‚Œã‚‹äº‹ã¨ãªã£ãŸã€‚
// window.addEventListener( "DOMContentLoaded", tblcontrol.init, false );
</script>
</body>
</html>